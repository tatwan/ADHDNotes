---
description: Instructions for AI Agent: Integrating "Karakeep" Bookmarking into ADHDNotes
---

## 1. Project Context & Mission

Current State:

We have an existing, functional desktop application called ADHDNotes.

- **Stack:** Electron, React, TypeScript, Vite, CodeMirror 6.
- **Data Model:** Local-first, filesystem-based. Notes are stored as Markdown (`.md`) files in the user's Documents folder.
- **Key Features:** Markdown editing, task management, local filesystem watching (`chokidar`), and specific ADHD-friendly workflows (forced prioritization).

The Objective:

We need to integrate advanced "Read-it-Later" and Bookmarking capabilities inspired by the architecture of Karakeep (an open-source bookmarking tool), without altering or removing any of the existing ADHDNotes functionality.

The Vision:

The app will now have two distinct "modes" or views in the left sidebar:

1. **Notes** (The existing functionality).
2. **Bookmarks** (The new functionality).

The Bookmarks feature must allow users to capture content from the web via a **Chrome Extension**, save it locally, organize it with AI auto-tagging, and reference it within their Notes.

------

## 2. Architectural Decisions & Tech Stack Additions

To achieve this "Karakeep-lite" integration within our existing Electron app without bloating it unnecessarily, adhere to the following architectural guidelines:

### A. Data Storage (Hybrid Approach)

- **Existing Notes:** Continue using plain `.md` files (Do not change this).
- **New Bookmarks Metadata:** Use **SQLite** with **Drizzle ORM**.
  - *Reasoning:* Bookmarks require structured queries (filtering by tags, full-text search, URLs, crawl status) which are inefficient with plain flat files.
  - *Location:* Store the `bookmarks.db` in the existing `~/Documents/ADHDNotes/_system/` folder (create this hidden folder).
- **New Bookmarks Assets:** Store heavy assets (snapshots, PDFs, images) in `~/Documents/ADHDNotes/bookmarks/assets/`.

### B. Local Server (The Bridge)

- We cannot rely solely on IPC for the Browser Extension. The Electron Main process must spawn a lightweight **local HTTP server** (using `fastify` or `express`) on a specific port (e.g., 3666).
- **Purpose:** This server listens for requests *from* the Chrome Extension to capture content.
- **Security:** Ensure it only accepts requests from localhost and utilizes a shared secret/token generated by the app.

### C. Background Processing (The "Worker")

- Crawling websites and running local AI inference is CPU-intensive.
- **Implementation:** Use **Electron UtilityProcess** or hidden `BrowserWindow` workers to handle:
  - Fetching URLs (using `cheerio` for metadata, or a lightweight headless scrape).
  - Downloading assets (PDFs, images).
  - Running AI tagging logic.
- *Note:* Avoid full Playwright integration inside Electron if possible to keep bundle size manageable. Use `readability`and `metascraper` libraries first. If full DOM rendering is needed, use a hidden Electron window.

------

## 3. Detailed Feature Specifications

### Feature A: The "Bookmarks" Panel

**UI Changes:**

1. **Sidebar Switcher:** Add a sleek toggle or tab system at the very top of the existing Left Sidebar: `[ Notes | Bookmarks ]`.
2. **Bookmarks View:** When selected, the sidebar displays a list/grid of saved bookmarks instead of the file tree.
   - *Filter:* Filter by "Unread", "Favorites", "Videos", "Articles".
   - *Tags:* Show a tag cloud (generated by AI).
3. **Main View (Renderer):** When a bookmark is clicked in the sidebar, render a new "Reader View" in the main content area (replacing the Markdown editor temporarily).
   - *Reader View:* Displays the cleaned HTML content (readability view), the user's highlights, and metadata.
   - *Action Bar:* "Open Original", "Copy Link", "Create Note from Bookmark", "Delete".

### Feature B: The Chrome Extension

Tech Stack: React, Vite, Manifest V3.

Capabilities:

1. **Save Page:** Captures URL, Title, Description, Favicon, and "Readable" HTML content. Sends to the Electron Local Server.
2. **Highlight & Save:** User selects text -> Right Click -> "Save Highlight to ADHDNotes".
   - *Payload:* Text content, serialized DOM range/XPath (to locate it later), Source URL.
3. **Save Image/PDF:** Context menu option to save specific media assets directly to the app's asset folder.
4. **Connection Check:** The extension icon should indicate if ADHDNotes is running (Green dot) or closed (Red dot).

### Feature C: AI Auto-Tagging & Summarization

**Implementation:**

- Add a section in the existing `SettingsModal` for **"AI Services"**.
  - Options: "Local (Ollama)" or "Cloud (OpenAI)".
- **Logic:** When a new bookmark is saved:
  1. Extract text content.
  2. Send to LLM with a prompt: *"Analyze this content and provide 5 relevant tags and a 1-sentence summary. Return JSON."*
  3. Save tags to SQLite database.

------

## 4. Implementation Steps for the Agent

### Step 1: Backend & Database Setup (Electron Main)

1. **Install Dependencies:**

   Bash

   ```
   npm install drizzle-orm better-sqlite3 fastify @mozilla/readability jsdom metascraper metascraper-title metascraper-description metascraper-image
   npm install -D drizzle-kit @types/better-sqlite3 @types/jsdom
   ```

2. **Initialize DB:**

   - Create `electron/db/schema.ts`. Define tables: `bookmarks`, `tags`, `bookmarks_tags`, `highlights`.
   - Initialize the SQLite database in `electron/main.js`.

3. **Local Server:**

   - Create `electron/server.ts`.
   - Implement POST routes: `/api/save-bookmark`, `/api/save-highlight`, `/api/status`.
   - Ensure this server starts when Electron starts and stops when it quits.

### Step 2: The Browser Extension

1. **Create Directory:** Create a new folder `extension/` at the root.
2. **Setup:** Initialize a basic Vite+React extension project (Manifest V3).
3. **Functionality:**
   - Implement a popup that shows "Connected to ADHDNotes" status.
   - Implement `background.js` to handle context menu clicks ("Save to ADHDNotes").
   - Implement `contentScript.js` to handle scraping page content (`document.cloneNode`, Readability parsing) and sending it to `http://localhost:3666`.

### Step 3: UI Integration (React Renderer)

1. **Sidebar Modification:**
   - Modify `src/components/layout/Sidebar.tsx`.
   - Introduce state `viewMode: 'notes' | 'bookmarks'`.
   - Create `src/components/bookmarks/BookmarkList.tsx` (The Sidebar view for bookmarks).
2. **Main View Routing:**
   - Modify `src/components/layout/AppLayout.tsx` to conditional render.
   - If a note is selected -> Show `MarkdownEditor`.
   - If a bookmark is selected -> Show `BookmarkReader` (Create this component).
3. **Bookmark Reader Component:**
   - Display the saved "Readability" HTML sanitized.
   - Show Tags (allow editing).
   - Show Highlights associated with this URL.

### Step 4: Logic Wiring (The "Karakeep" Features)

1. **Asset Handling:**
   - In `electron/main.js`, handle the logic to download images/PDFs provided by the extension URLs and save them to `~/Documents/ADHDNotes/bookmarks/assets/`.
2. **AI Worker:**
   - Create a simple abstraction in `src/utils/ai.ts` that calls the configured LLM (OpenAI or Ollama) with bookmark content to generate tags.
3. **Note Integration:**
   - Add a feature in `BookmarkReader`: **"Reference in Daily Note"**.
   - Action: Appends a markdown link `[Title](saved-bookmark-id)` to the currently active Daily Note.

------

## 5. File Structure Changes

You are expected to add files, not modify existing structure logic unless necessary.

Plaintext

```
root/
├── extension/                  # [NEW] Source for Chrome Extension
│   ├── manifest.json
│   ├── src/
│   │   ├── background.ts
│   │   ├── content.ts
│   │   └── popup.tsx
│   └── vite.config.ts
├── electron/
│   ├── db/                     # [NEW] Drizzle/SQLite logic
│   │   ├── schema.ts
│   │   └── index.ts
│   ├── server/                 # [NEW] Local API Server
│   │   └── api.ts
│   └── services/               # [NEW] Business logic
│       ├── scraper.ts          # Metadata/Content extraction
│       └── ai.ts               # Tagging logic
├── src/
│   ├── components/
│   │   ├── bookmarks/          # [NEW] Bookmark UI Components
│   │   │   ├── BookmarkList.tsx
│   │   │   ├── BookmarkReader.tsx
│   │   │   └── BookmarkCard.tsx
│   │   └── layout/
│   │       └── Sidebar.tsx     # [MODIFY] Add tabs
│   └── stores/
│       └── bookmarkStore.ts    # [NEW] Zustand store for bookmarks
```

------

## 6. Constraints & Safety Checks

- **Do NOT** replace the existing File System logic for Notes. Notes must remain plain text files.
- **Do NOT** force the user to use AI. If no API key/Ollama is present, simply save the bookmark without auto-tags.
- **Performance:** The local server and scraping logic must run asynchronously. Do not block the Main Process or UI thread.
- **Offline First:** The app must work perfectly without internet (except for capturing new bookmarks). Cached bookmarks must be viewable offline.

## 7. Execution Order

1. Set up the **Drizzle/SQLite** layer in Electron.
2. Build the **Local API Server** inside Electron.
3. Create the **Chrome Extension** to talk to that server.
4. Build the **Sidebar UI** to display the data from SQLite.
5. Build the **Reader View** to display content.
6. Implement the **AI Auto-tagging** pipeline.